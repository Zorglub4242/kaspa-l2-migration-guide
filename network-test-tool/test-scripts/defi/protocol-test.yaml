# DeFi Test for Igra Network
# Uses funded account from .env

test: DeFi Protocol Test on Igra
description: Comprehensive DeFi testing with ERC20, DEX simulation, and NFTs

variables:
  

setup:
  accounts:
    deployer:
      privateKey: "env:PRIVATE_KEY"
    alice:
      balance: 0.1 ETH
    bob:
      balance: 0.1 ETH

scenario:
  - log: "=== Starting DeFi Test on Igra ==="

  # Check deployer balance first
  - call:
      to: "{{deployer}}"
      function: getBalance
    returns: deployer_balance

  - log: "Deployer balance: {{deployer_balance}}"

  # Fund test accounts from deployer
  - transfer: deployer -> alice, 0.1 ETH
  - transfer: deployer -> bob, 0.1 ETH

  - log: "Test accounts funded"

  # Deploy ERC20 token
  - deploy:
      contract: ERC20
      name: TestToken
      args: ["Test Token", "TEST", 1000000, 18]
      from: deployer
    returns: token

  - log: "Token deployed at {{token}}"

  # Transfer tokens
  - call:
      contract: token
      method: transfer
      args: [alice, 10000]
      from: deployer

  - call:
      contract: token
      method: transfer
      args: [bob, 10000]
      from: deployer

  # Check balances
  - call:
      contract: token
      method: balanceOf
      args: [alice]
    returns: alice_balance

  - log: "Alice token balance: {{alice_balance}}"

  # Token approval and transferFrom
  - call:
      contract: token
      method: approve
      args: [bob, 5000]
      from: alice

  - call:
      contract: token
      method: transferFrom
      args: [alice, deployer, 2500]
      from: bob

  # Deploy NFT
  - deploy:
      contract: ERC721
      name: TestNFT
      args: ["Test NFT", "TNFT"]
      from: deployer
    returns: nft

  - log: "NFT deployed at {{nft}}"

  # Mint NFTs
  - call:
      contract: nft
      method: mint
      args: [alice, 1]
      from: deployer

  - call:
      contract: nft
      method: mint
      args: [bob, 2]
      from: deployer

  # Check NFT ownership
  - call:
      contract: nft
      method: ownerOf
      args: [1]
    returns: nft_owner_1

  - check: "nft_owner_1 == alice"

  # Transfer NFT
  - call:
      contract: nft
      method: transferFrom
      args: [alice, bob, 1]
      from: alice

  - call:
      contract: nft
      method: ownerOf
      args: [1]
    returns: new_owner_1

  - check: "new_owner_1 == bob"

  - log: "=== DeFi Test Completed Successfully ==="